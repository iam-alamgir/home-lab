name: "is-traefik"

services:
  traefik:
    image: docker.io/library/traefik:3.4.1
    container_name: ${TRAEFIK_CONTAINER_NAME}
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true
    environment:
      - TZ=${TZ}
      - PUID=${UID}
      - PGID=${GID}
      - CF_DNS_API_TOKEN=${TRAEFIK_DNS_API_TOKEN}
      - CLOUDFLARE_POLLING_INTERVAL=${TRAEFIK_POLLING_INTERVAL}
      - CLOUDFLARE_PROPAGATION_TIMEOUT=${TRAEFIK_PROPAGATION_TIMEOUT}
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /run/user/${UID}/podman/podman.sock:/var/run/docker.sock:ro
      - ${TRAEFIK_VOL_STATIC_CONF}:/etc/traefik/traefik_conf.yml:ro
      - ${TRAEFIK_VOL_DYNAMIC_CONF}:/etc/traefik/dynamic_conf/:ro
      - ${TRAEFIK_VOL_ACME}:/etc/traefik/acme.json:rw
    networks:
      proxy:
        ipv4_address: ${TRAEFIK_PROXY_IPV4}
      private:
        ipv4_address: ${TRAEFIK_PRIVATE_IPV4}
      public:
        ipv4_address: ${TRAEFIK_PUBLIC_IPV4}
      monitoring:
        ipv4_address: ${TRAEFIK_MONITORING_IPV4}
    ports:
      - ${HOST_HTTP_PORT}:80
      - ${HOST_HTTPS_PORT}:443
      - ${HOST_HTTP_PORT_EXTERNAL}:8089
      - ${HOST_HTTPS_PORT_EXTERNAL}:4439
    command:
      - --configFile=/etc/traefik/traefik_conf.yml
    labels:
      # enable traefik
      - "traefik.enable=true"

      # http config
      - "traefik.http.routers.traefik.entrypoints=web"
      - "traefik.http.routers.traefik.rule=Host(`${TRAEFIK_UI_ADDRESS}`)"

      # https config
      - "traefik.http.routers.traefik-secure.entrypoints=web-secure"
      - "traefik.http.routers.traefik-secure.rule=Host(`${TRAEFIK_UI_ADDRESS}`)"
      - "traefik.http.routers.traefik-secure.tls=true"

      # ui service config
      - "traefik.http.routers.traefik-secure.service=api@internal"

      # cert resolver config
      - "traefik.http.routers.traefik-secure.tls.certresolver=cloudflare"
      - "traefik.http.routers.traefik-secure.tls.domains[0].main=${TRAEFIK_ROOT_DOMAIN}"
      - "traefik.http.routers.traefik-secure.tls.domains[0].sans=${TRAEFIK_SUB_DOMAINS}"

      # network config
      - "traefik.docker.network=${NET_PRIVATE}"

networks:
  proxy:
    name: ${NET_PROXY}
    external: true
  private:
    name: ${NET_PRIVATE}
    external: true
  public:
    name: ${NET_PUBLIC}
    external: true
  monitoring:
    name: ${NET_MONITORING}
    external: true
